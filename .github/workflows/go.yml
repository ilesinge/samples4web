name: Go

on:
  workflow_dispatch:
#  push:
#    branches: [ master ]

# based on https://github.com/wolfgangasdf/gocalcapp/blob/master/.github/workflows/go.yml
jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create-release-step.outputs.upload_url }}
    steps:
      - name: Make release
        id: "create-release-step"
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: false
          title: "Latest build"

  package-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install native deps
        run: |
          sudo apt update
          sudo apt install gcc libgl1-mesa-dev xorg-dev -y
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.18
      - name: Install Fyne CLI
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@latest
          $HOME/go/bin/fyne version
      - name: Fyne Package
        run: |
          go generate -v
          $HOME/go/bin/fyne package -icon Icon.png
          mv Samples4web.tar.xz Samples4web-linux.tar.xz
      - name: Upload package
        uses: actions/upload-artifact@v2
        with:
          name: 'Samples4web-linux.tar.xz'
          path: '.'
      - name: Add to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./Samples4web-linux.tar.xz
          asset_name: Samples4web-linux.tar.xz
          asset_content_type: application/x-tar

  package-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install native deps
        run: |
          choco install msys2
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.18
      - name: Install Fyne CLI
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@latest
          Start-Process -PSPath "$HOME\go\bin\fyne.exe" -ArgumentList "version" -NoNewWindow -Wait
      - name: Fyne Package
        run: |
          go generate -v
          Start-Process -PSPath "$HOME\go\bin\fyne.exe" -ArgumentList "package -icon Icon.png" -NoNewWindow -Wait
      - name: Zip Release
        uses: TheDoctor0/zip-release@main
        with:
          type: 'zip'
          filename: 'Samples4web-windows.zip'
          path: 'Samples4web.exe'
      - name: Upload package
        uses: actions/upload-artifact@v2
        with:
          name: 'Samples4web-windows.zip'
          path: '.'
      - name: Add to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./Samples4web-windows.zip
          asset_name: Samples4web-windows.zip
          asset_content_type: application/zip

  package-mac:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.18
      - name: Install Fyne CLI
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@latest
          $HOME/go/bin/fyne version
      - name: Install create-dmg
        run: npm install --global create-dmg
      - name: Fyne Package
        run: |
          go generate -v
          $HOME/go/bin/fyne package -icon Icon.png
      - name: Create DMG
        continue-on-error: true
        run: create-dmg Samples4web.app
      - name: Rename DMG
        run: mv "Samples4web 1.0.0.dmg" Samples4web-mac.dmg
      - name: Zip Release
        uses: TheDoctor0/zip-release@main
        with:
          type: 'zip'
          filename: 'Samples4web-mac.zip'
          path: 'Samples4web.app'
      - name: Upload package
        uses: actions/upload-artifact@v2
        with:
          name: 'Samples4web-mac.zip'
          path: '.'
      - name: Upload DMG
        uses: actions/upload-artifact@v2
        with:
          name: 'Samples4web-mac.dmg'
          path: '.'
      - name: Add to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./Samples4web-mac.zip
          asset_name: Samples4web-mac.zip
          asset_content_type: application/zip
      - name: Add to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./Samples4web-mac.dmg
          asset_name: Samples4web-mac.dmg
          asset_content_type: application/octet-stream
